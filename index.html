<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<title>Harrison's Strawberry Farm ğŸ“</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & BASE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;touch-action:manipulation;user-select:none;-webkit-user-select:none;-ms-touch-action:manipulation}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS VARIABLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --sky-top:#87CEEB;--sky-bot:#E0F7FA;
  --grass-top:#4CAF50;--grass-bot:#2E7D32;
  --dirt:#8B6914;--dirt-dark:#6B4F12;
  --straw-red:#FF1744;--straw-green:#43A047;
  --gold:#FFD700;--purple:#9C27B0;
  --ui-bg:rgba(255,255,255,0.92);--ui-shadow:0 4px 20px rgba(0,0,0,0.15);
  --bounce:cubic-bezier(0.34,1.56,0.64,1);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME CONTAINER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game-container{
  width:100%;height:100%;position:relative;
  background:linear-gradient(180deg,var(--sky-top) 0%,var(--sky-bot) 55%,var(--grass-top) 55.1%,var(--grass-bot) 100%);
  overflow:hidden;
}
#game-container.shake{animation:shake 0.3s ease-out}
@keyframes shake{
  0%,100%{transform:translate(0)}
  10%{transform:translate(-6px,-3px)}
  30%{transform:translate(6px,3px)}
  50%{transform:translate(-4px,4px)}
  70%{transform:translate(4px,-2px)}
  90%{transform:translate(-2px,2px)}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPEED ROUND BORDER GLOW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game-container.speed-round{
  box-shadow:inset 0 0 40px rgba(255,0,0,0.5),inset 0 0 80px rgba(255,0,0,0.2);
  animation:speedPulse 0.5s ease-in-out infinite alternate;
}
@keyframes speedPulse{
  0%{box-shadow:inset 0 0 40px rgba(255,0,0,0.4),inset 0 0 80px rgba(255,0,0,0.15)}
  100%{box-shadow:inset 0 0 60px rgba(255,0,0,0.7),inset 0 0 120px rgba(255,0,0,0.3)}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GOLDEN FLASH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.golden-flash{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(255,215,0,0.3);z-index:200;pointer-events:none;
  animation:goldenFlashAnim 0.4s ease-out forwards;
}
@keyframes goldenFlashAnim{0%{opacity:1}100%{opacity:0}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKY ELEMENTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sun{
  position:absolute;top:5%;right:8%;width:80px;height:80px;
  background:radial-gradient(circle,#FFF176 30%,#FFD54F 60%,rgba(255,213,79,0) 70%);
  border-radius:50%;animation:sunPulse 3s ease-in-out infinite;
  filter:drop-shadow(0 0 20px rgba(255,213,79,0.6));z-index:1;
}
@keyframes sunPulse{0%,100%{transform:scale(1);filter:drop-shadow(0 0 20px rgba(255,213,79,0.6))}50%{transform:scale(1.08);filter:drop-shadow(0 0 30px rgba(255,213,79,0.8))}}
.sun-rays{
  position:absolute;top:0;left:0;width:100%;height:100%;animation:sunSpin 20s linear infinite;
}
.sun-rays::before,.sun-rays::after{
  content:'';position:absolute;top:50%;left:50%;
  width:120%;height:4px;background:rgba(255,213,79,0.3);
  transform-origin:center;border-radius:2px;
}
.sun-rays::before{transform:translate(-50%,-50%) rotate(0deg)}
.sun-rays::after{transform:translate(-50%,-50%) rotate(60deg)}
@keyframes sunSpin{to{transform:rotate(360deg)}}

.cloud{
  position:absolute;background:#fff;border-radius:50px;
  box-shadow:0 4px 15px rgba(0,0,0,0.05);z-index:2;
  animation:cloudFloat linear infinite;
}
.cloud::before,.cloud::after{
  content:'';position:absolute;background:#fff;border-radius:50%;
}
.cloud::before{width:60%;height:140%;top:-40%;left:20%}
.cloud::after{width:40%;height:100%;top:-30%;left:55%}
@keyframes cloudFloat{from{transform:translateX(110vw)}to{transform:translateX(-200px)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GROUND / FARM FIELD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#farm-field{
  position:absolute;top:50%;left:0;right:0;bottom:0;
  overflow:hidden;z-index:5;
}
.dirt-rows{
  position:absolute;top:0;left:0;right:0;bottom:0;
  background:repeating-linear-gradient(
    180deg,
    rgba(139,105,20,0.15) 0px,rgba(139,105,20,0.15) 2px,
    transparent 2px,transparent 60px
  );
}
.grass-blades{
  position:absolute;top:-8px;left:0;right:0;height:20px;
  background:repeating-linear-gradient(
    90deg,
    transparent 0px,transparent 8px,
    var(--grass-top) 8px,var(--grass-top) 12px
  );
  mask-image:linear-gradient(180deg,#000 0%,transparent 100%);
  -webkit-mask-image:linear-gradient(180deg,#000 0%,transparent 100%);
  animation:grassWave 2s ease-in-out infinite alternate;
}
@keyframes grassWave{0%{transform:skewX(-2deg)}100%{transform:skewX(2deg)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STRAWBERRY STYLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.strawberry{
  position:absolute;cursor:pointer;transition:transform 0.1s;
  z-index:10;filter:drop-shadow(2px 4px 3px rgba(0,0,0,0.2));
  animation:strawGrow 0.4s var(--bounce) forwards;
  transform:scale(0);
  min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;
}
.strawberry:hover{transform:scale(1.15)!important}
.strawberry:active{transform:scale(0.9)!important}
.strawberry.picked{
  animation:strawPick 0.35s ease-out forwards!important;
  pointer-events:none;
}
@keyframes strawGrow{to{transform:scale(1)}}
@keyframes strawPick{
  0%{transform:scale(1);opacity:1}
  30%{transform:scale(1.4) rotate(15deg);opacity:1}
  100%{transform:scale(0) rotate(45deg) translateY(-40px);opacity:0}
}

.straw-body{
  font-size:var(--size,42px);line-height:1;
  text-shadow:1px 2px 2px rgba(0,0,0,0.15);
}
.strawberry.golden .straw-body{filter:brightness(1.2) saturate(1.5);text-shadow:0 0 10px rgba(255,215,0,0.6)}
.strawberry.giant .straw-body{--size:62px}
.strawberry.rotten{filter:hue-rotate(80deg) brightness(0.7) saturate(0.8)}

.strawberry.golden::after{
  content:'âœ¨';position:absolute;top:-8px;right:-8px;font-size:16px;
  animation:sparkle 0.6s ease-in-out infinite alternate;
}
@keyframes sparkle{0%{opacity:0.5;transform:scale(0.8) rotate(-10deg)}100%{opacity:1;transform:scale(1.2) rotate(10deg)}}

/* stem wiggle for growing strawberries */
.strawberry.growing{animation:strawGrow 0.4s var(--bounce) forwards,wiggle 1.5s ease-in-out infinite 0.4s}
@keyframes wiggle{0%,100%{transform:rotate(0)}25%{transform:rotate(3deg)}75%{transform:rotate(-3deg)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RAINBOW STRAWBERRY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.strawberry.rainbow .straw-body{
  animation:rainbowHue 0.8s linear infinite;
  filter:saturate(2) brightness(1.2);
  --size:48px;
}
@keyframes rainbowHue{0%{filter:hue-rotate(0deg) saturate(2) brightness(1.2)}100%{filter:hue-rotate(360deg) saturate(2) brightness(1.2)}}
.strawberry.rainbow::before{
  content:'';position:absolute;top:50%;left:50%;width:60px;height:60px;
  background:conic-gradient(red,orange,yellow,green,blue,violet,red);
  border-radius:50%;opacity:0.3;transform:translate(-50%,-50%);
  animation:rainbowPulse 1s ease-in-out infinite alternate;z-index:-1;
}
@keyframes rainbowPulse{0%{transform:translate(-50%,-50%) scale(0.8);opacity:0.2}100%{transform:translate(-50%,-50%) scale(1.4);opacity:0.4}}
.rainbow-trail{
  position:absolute;pointer-events:none;z-index:8;
  width:10px;height:10px;border-radius:50%;
  animation:trailFade 0.6s ease-out forwards;
}
@keyframes trailFade{0%{transform:scale(1);opacity:0.7}100%{transform:scale(0);opacity:0}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RAIN STRAWBERRIES (falling from top)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.strawberry.rain-drop{
  animation:rainFall var(--fall-dur,2s) linear forwards!important;
  transform:scale(1)!important;
}
@keyframes rainFall{
  0%{transform:translateY(0) rotate(0deg);opacity:1}
  90%{opacity:1}
  100%{transform:translateY(var(--fall-dist,400px)) rotate(360deg);opacity:0.5}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STREAK ANNOUNCEMENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.streak-announce{
  position:fixed;top:30%;left:50%;transform:translate(-50%,-50%) scale(0);
  font-size:clamp(36px,10vw,72px);font-weight:900;color:#fff;z-index:300;
  text-shadow:3px 3px 0 rgba(0,0,0,0.3),0 0 40px rgba(255,215,0,0.8);
  pointer-events:none;
  animation:streakPop 1.2s var(--bounce) forwards;
  white-space:nowrap;
}
@keyframes streakPop{
  0%{transform:translate(-50%,-50%) scale(0) rotate(-15deg);opacity:0}
  20%{transform:translate(-50%,-50%) scale(1.3) rotate(5deg);opacity:1}
  40%{transform:translate(-50%,-50%) scale(1) rotate(0deg);opacity:1}
  80%{transform:translate(-50%,-50%) scale(1) rotate(0deg);opacity:1}
  100%{transform:translate(-50%,-50%) scale(0.5) rotate(10deg);opacity:0}
}
.streak-announce.amazing{color:#FFD700;text-shadow:3px 3px 0 #E65100,0 0 40px rgba(255,215,0,0.8)}
.streak-announce.legendary{color:#E040FB;text-shadow:3px 3px 0 #6A1B9A,0 0 40px rgba(224,64,251,0.8)}
.streak-announce.godmode{
  background:linear-gradient(135deg,#FF0000,#FF8800,#FFFF00,#00FF00,#0088FF,#8800FF);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  text-shadow:none;filter:drop-shadow(3px 3px 0 rgba(0,0,0,0.3));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RAIN EVENT ANNOUNCEMENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rain-announce{
  position:fixed;top:20%;left:50%;transform:translate(-50%,-50%) scale(0);
  font-size:clamp(28px,8vw,56px);font-weight:900;color:#FF1744;z-index:300;
  text-shadow:3px 3px 0 rgba(0,0,0,0.3),0 0 30px rgba(255,23,68,0.6);
  pointer-events:none;
  animation:rainAnnouncePop 2s var(--bounce) forwards;
  white-space:nowrap;
}
@keyframes rainAnnouncePop{
  0%{transform:translate(-50%,-50%) scale(0);opacity:0}
  15%{transform:translate(-50%,-50%) scale(1.2);opacity:1}
  30%{transform:translate(-50%,-50%) scale(1);opacity:1}
  75%{transform:translate(-50%,-50%) scale(1);opacity:1}
  100%{transform:translate(-50%,-50%) scale(0.3);opacity:0}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETTI
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.confetti-piece{
  position:fixed;width:10px;height:10px;z-index:400;pointer-events:none;
  animation:confettiFall var(--conf-dur,3s) ease-in forwards;
}
@keyframes confettiFall{
  0%{transform:translateY(0) rotate(0deg);opacity:1}
  100%{transform:translateY(100vh) rotate(var(--conf-rot,720deg));opacity:0}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN PULSE (big combo)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen-pulse{
  position:fixed;top:0;left:0;width:100%;height:100%;
  z-index:150;pointer-events:none;
  border:8px solid;border-radius:0;
  animation:screenPulseAnim 0.4s ease-out forwards;
}
@keyframes screenPulseAnim{
  0%{opacity:0.8;border-width:8px}
  100%{opacity:0;border-width:0px}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RANK BADGE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rank-badge{
  font-size:48px;margin:5px 0;animation:rankPop 0.6s var(--bounce);
}
@keyframes rankPop{0%{transform:scale(0) rotate(-30deg)}100%{transform:scale(1) rotate(0deg)}}
.rank-label{font-size:20px;font-weight:800;margin-bottom:10px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BIRDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bird{
  position:absolute;font-size:28px;z-index:15;cursor:pointer;
  animation:birdFly 0.4s ease-in-out infinite alternate;
  filter:drop-shadow(2px 3px 2px rgba(0,0,0,0.2));
  transition:transform 0.1s;
  min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;
}
.bird:hover{transform:scale(1.2)}
@keyframes birdFly{0%{transform:translateY(0) scaleX(1)}100%{transform:translateY(-8px) scaleX(-1)}}
.bird.scared{animation:birdScared 0.5s ease-out forwards!important;pointer-events:none}
@keyframes birdScared{to{transform:translateY(-200px) rotate(720deg) scale(0);opacity:0}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POWER-UPS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.powerup{
  position:absolute;cursor:pointer;z-index:12;font-size:32px;
  animation:powerFloat 1s ease-in-out infinite alternate, strawGrow 0.4s var(--bounce) forwards;
  transform:scale(0);
  filter:drop-shadow(0 0 8px rgba(255,255,255,0.8));
  min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;
}
@keyframes powerFloat{0%{transform:translateY(0) scale(1)}100%{transform:translateY(-10px) scale(1.1)}}
.powerup.collected{animation:powerCollect 0.4s ease-out forwards!important;pointer-events:none}
@keyframes powerCollect{to{transform:scale(2) translateY(-30px);opacity:0}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARTICLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.particle{
  position:absolute;pointer-events:none;z-index:50;
  border-radius:50%;
  animation:particleBurst 0.6s ease-out forwards;
}
@keyframes particleBurst{
  0%{transform:translate(0,0) scale(1);opacity:1}
  100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0}
}
.score-popup{
  position:absolute;pointer-events:none;z-index:55;
  font-weight:900;font-size:24px;color:#fff;
  text-shadow:2px 2px 0 var(--straw-red),-1px -1px 0 var(--straw-red),1px -1px 0 var(--straw-red),-1px 1px 0 var(--straw-red);
  animation:scoreFloat 0.8s ease-out forwards;
  white-space:nowrap;
}
.score-popup.combo{font-size:32px;color:var(--gold);text-shadow:2px 2px 0 #E65100,-1px -1px 0 #E65100,1px -1px 0 #E65100,-1px 1px 0 #E65100}
.score-popup.negative{color:#FF5252;text-shadow:2px 2px 0 #B71C1C,-1px -1px 0 #B71C1C,1px -1px 0 #B71C1C,-1px 1px 0 #B71C1C}
@keyframes scoreFloat{
  0%{transform:translateY(0) scale(0.5);opacity:1}
  20%{transform:translateY(-10px) scale(1.3)}
  100%{transform:translateY(-80px) scale(0.8);opacity:0}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLAYER CURSORS (MULTIPLAYER)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.player-cursor{
  position:absolute;pointer-events:none;z-index:60;
  transition:left 0.1s linear,top 0.1s linear;
  font-size:24px;
}
.player-cursor .cursor-name{
  position:absolute;top:-20px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.7);color:#fff;font-size:10px;
  padding:2px 6px;border-radius:8px;white-space:nowrap;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HUD / UI OVERLAY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#hud{
  position:absolute;top:0;left:0;right:0;
  display:flex;justify-content:space-between;align-items:flex-start;
  padding:10px 15px;z-index:80;pointer-events:none;
}
#hud>*{pointer-events:auto}
.hud-box{
  background:var(--ui-bg);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  border-radius:16px;padding:8px 16px;box-shadow:var(--ui-shadow);
  border:2px solid rgba(255,255,255,0.5);
}
#score-display{font-size:24px;font-weight:800;color:#E53935}
#score-display .score-label{font-size:12px;color:#888;font-weight:600;display:block}
#score-display .score-value{transition:transform 0.15s var(--bounce);display:inline-block}
#score-display .score-value.bump{transform:scale(1.3)}
#timer-display{
  text-align:center;min-width:70px;
}
#timer-display .timer-label{font-size:12px;color:#888;font-weight:600;display:block}
#timer-display .timer-value{font-size:28px;font-weight:900;color:#333;font-variant-numeric:tabular-nums}
#timer-display .timer-value.urgent{color:#E53935;animation:timerPulse 0.5s ease-in-out infinite}
@keyframes timerPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}

#combo-display{
  position:absolute;top:70px;left:50%;transform:translateX(-50%);
  font-size:20px;font-weight:900;color:var(--gold);
  text-shadow:2px 2px 0 #E65100;
  opacity:0;transition:all 0.2s var(--bounce);z-index:81;
  pointer-events:none;
}
#combo-display.active{opacity:1;transform:translateX(-50%) scale(1.1)}

#powerup-bar{
  position:absolute;bottom:15px;left:50%;transform:translateX(-50%);
  display:flex;gap:10px;z-index:80;
}
.powerup-indicator{
  background:var(--ui-bg);border-radius:12px;padding:6px 12px;
  box-shadow:var(--ui-shadow);font-size:14px;font-weight:700;
  display:flex;align-items:center;gap:4px;
  animation:powerupSlideIn 0.3s var(--bounce);
}
@keyframes powerupSlideIn{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
.powerup-indicator .pw-timer{
  width:30px;height:4px;background:#ddd;border-radius:2px;overflow:hidden;
}
.powerup-indicator .pw-timer-fill{
  height:100%;background:var(--gold);border-radius:2px;
  transition:width 0.1s linear;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MULTIPLAYER SCOREBOARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scoreboard{
  position:absolute;top:70px;right:15px;z-index:80;
  background:var(--ui-bg);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  border-radius:16px;padding:10px 14px;box-shadow:var(--ui-shadow);
  border:2px solid rgba(255,255,255,0.5);
  min-width:140px;display:none;
}
#scoreboard.visible{display:block}
#scoreboard h3{font-size:12px;color:#888;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
.sb-entry{
  display:flex;justify-content:space-between;align-items:center;
  padding:3px 0;font-size:14px;font-weight:600;
  border-bottom:1px solid rgba(0,0,0,0.05);
}
.sb-entry:last-child{border:none}
.sb-entry .sb-name{color:#333;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sb-entry .sb-score{color:#E53935;font-variant-numeric:tabular-nums}
.sb-entry.me{color:#1565C0}
.sb-entry.me .sb-score{color:#1565C0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MENU SCREENS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{
  position:absolute;top:0;left:0;right:0;bottom:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:100;transition:opacity 0.4s,transform 0.4s;
  padding:20px;
}
.screen.hidden{opacity:0;pointer-events:none;transform:scale(1.05)}

#title-screen{
  background:linear-gradient(180deg,#FFEBEE 0%,#FFF9C4 50%,#C8E6C9 100%);
}
.title-logo{
  font-size:clamp(32px,8vw,64px);font-weight:900;
  color:#E53935;text-shadow:3px 3px 0 #B71C1C;
  animation:titleBounce 2s ease-in-out infinite;
  text-align:center;line-height:1.2;
}
.title-logo .title-name{
  display:block;font-size:clamp(40px,10vw,80px);
  background:linear-gradient(135deg,#E53935,#FF6F00,#E53935);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}
.title-straw{
  font-size:clamp(60px,15vw,120px);
  animation:titleStrawBounce 1s var(--bounce) infinite alternate;
  display:block;margin:10px 0;
}
@keyframes titleBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes titleStrawBounce{0%{transform:scale(1) rotate(-5deg)}100%{transform:scale(1.15) rotate(5deg)}}

.title-subtitle{
  font-size:clamp(14px,3vw,20px);color:#795548;font-weight:600;
  margin-top:5px;opacity:0.8;
}

.menu-buttons{
  margin-top:30px;display:flex;flex-direction:column;gap:12px;width:min(300px,80vw);
}
.btn{
  padding:14px 28px;border:none;border-radius:16px;
  font-size:18px;font-weight:800;cursor:pointer;
  transition:all 0.15s var(--bounce);
  box-shadow:0 4px 0 rgba(0,0,0,0.2),var(--ui-shadow);
  text-transform:uppercase;letter-spacing:1px;
  position:relative;overflow:hidden;
}
.btn:hover{transform:translateY(-2px);box-shadow:0 6px 0 rgba(0,0,0,0.2),0 8px 25px rgba(0,0,0,0.15)}
.btn:active{transform:translateY(2px);box-shadow:0 1px 0 rgba(0,0,0,0.2),0 2px 10px rgba(0,0,0,0.1)}
.btn-primary{background:linear-gradient(135deg,#E53935,#FF5252);color:#fff}
.btn-secondary{background:linear-gradient(135deg,#43A047,#66BB6A);color:#fff}
.btn-gold{background:linear-gradient(135deg,#FF8F00,#FFB300);color:#fff}
.btn-small{padding:10px 20px;font-size:14px;border-radius:12px}

.input-group{
  display:flex;flex-direction:column;gap:8px;margin-top:15px;width:min(300px,80vw);
}
.input-group label{font-size:14px;font-weight:700;color:#555}
.input-group input{
  padding:12px 16px;border:2px solid #ddd;border-radius:12px;
  font-size:16px;font-weight:600;text-align:center;
  outline:none;transition:border-color 0.2s;
}
.input-group input:focus{border-color:#E53935}

#multiplayer-screen .room-code{
  font-size:clamp(28px,7vw,48px);font-weight:900;
  color:#1565C0;letter-spacing:4px;margin:15px 0;
  font-family:monospace;
}
#multiplayer-screen .status-text{
  font-size:14px;color:#666;margin:8px 0;
}
.players-list{
  display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:10px 0;
}
.player-tag{
  background:#E3F2FD;color:#1565C0;padding:6px 12px;
  border-radius:20px;font-size:13px;font-weight:700;
  animation:popIn 0.3s var(--bounce);
}
@keyframes popIn{from{transform:scale(0)}to{transform:scale(1)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME OVER SCREEN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#gameover-screen{
  background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
}
.gameover-card{
  background:#fff;border-radius:24px;padding:30px 40px;
  box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center;
  max-width:min(400px,85vw);width:100%;
  animation:cardSlideIn 0.5s var(--bounce);
}
@keyframes cardSlideIn{from{transform:translateY(50px) scale(0.9);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
.gameover-card h2{font-size:28px;color:#E53935;margin-bottom:5px}
.gameover-card .final-score{
  font-size:48px;font-weight:900;
  background:linear-gradient(135deg,#E53935,#FF6F00);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  margin:10px 0;
}
.gameover-card .stats{
  display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:15px 0;
}
.gameover-card .stat{
  background:#F5F5F5;border-radius:12px;padding:10px;
}
.gameover-card .stat-label{font-size:11px;color:#888;text-transform:uppercase;font-weight:600}
.gameover-card .stat-value{font-size:20px;font-weight:800;color:#333}
.final-leaderboard{
  margin:15px 0;text-align:left;
}
.final-leaderboard h3{font-size:14px;color:#888;margin-bottom:8px;text-transform:uppercase}
.final-lb-entry{
  display:flex;justify-content:space-between;padding:6px 10px;
  border-radius:8px;margin:3px 0;font-weight:600;
}
.final-lb-entry:nth-child(2){background:#FFF9C4;color:#F57F17}
.final-lb-entry:nth-child(3){background:#F5F5F5;color:#666}

/* Quick restart hint */
.restart-hint{
  margin-top:12px;font-size:13px;color:#999;font-weight:600;
  animation:hintPulse 2s ease-in-out infinite;
}
@keyframes hintPulse{0%,100%{opacity:0.5}50%{opacity:1}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOUND TOGGLE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sound-toggle{
  position:absolute;top:12px;left:50%;transform:translateX(-50%);
  z-index:90;background:var(--ui-bg);border:none;
  border-radius:50%;width:36px;height:36px;font-size:18px;
  cursor:pointer;box-shadow:var(--ui-shadow);display:flex;
  align-items:center;justify-content:center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DECORATIVE FLOWERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.flower{
  position:absolute;z-index:4;font-size:20px;
  animation:flowerSway 3s ease-in-out infinite alternate;
}
@keyframes flowerSway{0%{transform:rotate(-5deg)}100%{transform:rotate(5deg)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:500px){
  #hud{padding:8px 10px}
  .hud-box{padding:6px 10px;border-radius:12px}
  #score-display{font-size:20px}
  #timer-display .timer-value{font-size:22px}
  #scoreboard{top:55px;right:8px;min-width:110px;padding:8px 10px}
  .sb-entry{font-size:12px}
  #combo-display{top:55px;font-size:16px}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAKE ATTACK SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sake-item{
  position:absolute;font-size:28px;cursor:pointer;z-index:20;
  animation:sakeFloat 1.5s ease-in-out infinite;
  filter:drop-shadow(0 2px 6px rgba(0,0,0,0.3));
  transition:transform 0.2s var(--bounce);
  min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;
}
.sake-item:active{transform:scale(0.8)}
.sake-item.collected{animation:popOut 0.3s ease-out forwards}

.sake-ammo{
  position:fixed;bottom:80px;right:12px;z-index:100;
  background:rgba(0,0,0,0.7);color:#fff;border-radius:16px;
  padding:6px 14px;font-size:18px;font-weight:bold;
  display:none;backdrop-filter:blur(4px);
  border:2px solid rgba(255,255,255,0.2);
  animation:fadeSlideUp 0.3s var(--bounce);
}
.sake-ammo.has-ammo{display:flex;align-items:center;gap:6px}

.player-cursor.targetable{cursor:crosshair;filter:drop-shadow(0 0 8px rgba(255,0,0,0.5))}
.player-cursor .sake-target{
  position:absolute;top:-10px;left:-10px;right:-10px;bottom:-10px;
  border:2px dashed rgba(255,0,0,0.5);border-radius:50%;
  animation:targetPulse 0.8s ease-in-out infinite;
}
@keyframes targetPulse{0%,100%{transform:scale(1);opacity:0.5}50%{transform:scale(1.2);opacity:1}}

.sake-projectile{
  position:fixed;font-size:32px;z-index:150;pointer-events:none;
  transition:all 0.4s ease-in;
}

.sake-splash{
  position:fixed;z-index:200;pointer-events:none;
  font-size:48px;animation:sakeSplash 0.8s ease-out forwards;
}
@keyframes sakeSplash{
  0%{transform:scale(0.5) rotate(0deg);opacity:1}
  50%{transform:scale(1.5) rotate(180deg);opacity:0.8}
  100%{transform:scale(2) rotate(360deg);opacity:0}
}

#game-container.drunk{
  animation:drunkWobble 0.5s ease-in-out infinite !important;
}
@keyframes drunkWobble{
  0%,100%{transform:rotate(0deg) skewX(0deg)}
  25%{transform:rotate(1.5deg) skewX(1deg)}
  75%{transform:rotate(-1.5deg) skewX(-1deg)}
}

.drunk-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(139,69,19,0.15);z-index:90;pointer-events:none;
  animation:drunkPulse 1s ease-in-out infinite;
}
@keyframes drunkPulse{0%,100%{opacity:0.1}50%{opacity:0.25}}

.sake-hit-flash{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(255,165,0,0.4);z-index:200;pointer-events:none;
  animation:sakeFlash 0.5s ease-out forwards;
}
@keyframes sakeFlash{0%{opacity:1}100%{opacity:0}}

@keyframes sakeFloat{0%,100%{transform:translateY(0) rotate(-5deg)}50%{transform:translateY(-8px) rotate(5deg)}}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIVE GAMES LOBBY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.live-games{
  margin-top:12px;width:100%;max-width:320px;
}
.live-games h3{
  font-size:16px;color:#333;margin-bottom:8px;
  display:flex;align-items:center;gap:6px;
}
.live-games h3 .pulse-dot{
  width:10px;height:10px;background:#4CAF50;border-radius:50%;
  animation:pulseDot 1.5s ease-in-out infinite;
}
@keyframes pulseDot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(0.7)}}
.live-games-list{
  display:flex;flex-direction:column;gap:6px;max-height:180px;overflow-y:auto;
}
.live-game-card{
  background:rgba(255,255,255,0.95);border:2px solid #E8F5E9;
  border-radius:12px;padding:10px 14px;cursor:pointer;
  display:flex;justify-content:space-between;align-items:center;
  transition:all 0.2s ease;
}
.live-game-card:hover{border-color:#4CAF50;transform:scale(1.02);box-shadow:0 2px 12px rgba(76,175,80,0.2)}
.live-game-card:active{transform:scale(0.98)}
.live-game-card .game-host{font-weight:bold;font-size:14px}
.live-game-card .game-players{font-size:12px;color:#666}
.live-game-card .join-arrow{font-size:20px;color:#4CAF50}
.no-games{color:#999;font-size:13px;text-align:center;padding:12px}
.refreshing{opacity:0.6}

</style>
</head>
<body>
<script>
// Prevent double-tap zoom on mobile
document.addEventListener('touchstart', function(e) {
  if (e.touches.length > 1) e.preventDefault();
}, { passive: false });
let lastTouchEnd = 0;
document.addEventListener('touchend', function(e) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) { e.preventDefault(); }
  lastTouchEnd = now;
}, { passive: false });
document.addEventListener('gesturestart', function(e) { e.preventDefault(); }, { passive: false });
</script>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GAME CONTAINER
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game-container">
  <!-- Sky -->
  <div class="sun"><div class="sun-rays"></div></div>

  <!-- Farm Field -->
  <div id="farm-field">
    <div class="grass-blades"></div>
    <div class="dirt-rows"></div>
  </div>

  <!-- HUD -->
  <div id="hud">
    <div class="hud-box" id="score-display">
      <span class="score-label">SCORE</span>
      <span class="score-value" id="score-value">0</span>
    </div>
    <div class="hud-box" id="timer-display">
      <span class="timer-label">TIME</span>
      <span class="timer-value" id="timer-value">60</span>
    </div>
    <div class="hud-box" id="hud-right" style="font-size:14px;font-weight:700;color:#555">
      ğŸ“ <span id="picked-count">0</span>
    </div>
  </div>

  <div id="combo-display">ğŸ”¥ COMBO x<span id="combo-value">2</span></div>

  <button id="sound-toggle" onclick="toggleSound()">ğŸ”Š</button>

  <div id="powerup-bar"></div>

  <div id="scoreboard">
    <h3>ğŸ† Players</h3>
    <div id="scoreboard-entries"></div>
  </div>

  <!-- â•â•â•â•â• TITLE SCREEN â•â•â•â•â• -->
  <div class="screen" id="title-screen">
    <div class="title-logo">
      <span class="title-straw">ğŸ“</span>
      <span class="title-name">Harrison's</span>
      Strawberry Farm
    </div>
    <div class="title-subtitle">Pick 'em all before time runs out!</div>
    <div class="menu-buttons">
      <button class="btn btn-primary" onclick="startSinglePlayer()">ğŸ® Solo Play</button>
      <button class="btn btn-secondary" onclick="showHostScreen()">ğŸŒ Host Game</button>
      <button class="btn btn-gold" onclick="showJoinScreen()">ğŸ¤ Join Code</button>
    </div>
    <div class="live-games" id="live-games">
      <h3><span class="pulse-dot"></span> Live Games</h3>
      <div class="live-games-list" id="live-games-list">
        <div class="no-games">Scanning for games...</div>
      </div>
    </div>
    <div class="input-group" style="margin-top:20px">
      <label>Your Name</label>
      <input type="text" id="player-name" placeholder="Your name" maxlength="12" value="">
    </div>
  </div>

  <!-- â•â•â•â•â• MULTIPLAYER SCREEN â•â•â•â•â• -->
  <div class="screen hidden" id="multiplayer-screen">
    <div class="title-logo" style="font-size:28px">
      ğŸ“ Multiplayer Lobby
    </div>
    <div class="room-code" id="room-code">----</div>
    <div class="status-text" id="lobby-status">Connecting...</div>
    <div class="players-list" id="players-list"></div>
    <div class="menu-buttons" style="margin-top:20px">
      <button class="btn btn-primary" id="start-mp-btn" onclick="startMultiplayerGame()" style="display:none">ğŸš€ Start Game!</button>
      <button class="btn btn-small btn-secondary" onclick="backToTitle()">â† Back</button>
    </div>
    <div class="input-group" id="join-input" style="display:none;margin-top:15px">
      <label>Room Code</label>
      <input type="text" id="join-code" placeholder="ABCD" maxlength="4" style="text-transform:uppercase;letter-spacing:4px;font-size:24px">
      <button class="btn btn-gold btn-small" onclick="joinRoom()">Join!</button>
    </div>
  </div>

  <!-- â•â•â•â•â• GAME OVER SCREEN â•â•â•â•â• -->
  <div class="screen hidden" id="gameover-screen">
    <div class="gameover-card">
      <h2>â° Time's Up!</h2>
      <div class="rank-badge" id="rank-badge"></div>
      <div class="rank-label" id="rank-label"></div>
      <div class="final-score" id="final-score">0</div>
      <div class="stats">
        <div class="stat"><div class="stat-label">Picked</div><div class="stat-value" id="stat-picked">0</div></div>
        <div class="stat"><div class="stat-label">Best Combo</div><div class="stat-value" id="stat-combo">0</div></div>
        <div class="stat"><div class="stat-label">Golden</div><div class="stat-value" id="stat-golden">0</div></div>
        <div class="stat"><div class="stat-label">Rotten Hit</div><div class="stat-value" id="stat-rotten">0</div></div>
      </div>
      <div class="final-leaderboard" id="final-leaderboard"></div>
      <div class="menu-buttons">
        <button class="btn btn-primary" onclick="playAgain()">ğŸ”„ Play Again</button>
        <button class="btn btn-small btn-secondary" onclick="backToTitle()">ğŸ  Menu</button>
      </div>
      <div class="restart-hint">Tap anywhere or press SPACE to restart</div>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const G = {
  score:0,picked:0,combo:0,maxCombo:0,goldenPicked:0,rottenHit:0,rainbowPicked:0,
  timeLeft:60,roundDuration:60,
  running:false,gameOverShown:false,
  strawberries:[],birds:[],powerups:[],
  activePowers:{},
  spawnRate:800,birdRate:8000,powerupRate:12000,
  timers:{},
  isHost:false,isMultiplayer:false,
  players:{},myId:'',roomCode:'',
  soundOn:true,audioCtx:null,
  sakeAmmo:0,isDrunk:false,drunkTimer:null,sakeItems:[],
  speedRoundActive:false,
  lastRainEvent:0,
  streakShown:{},
};

const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
const field=$('#farm-field');

/* Supabase Realtime for multiplayer */
const SUPA_URL='https://vvvxgoqlnltukhtlpdxx.supabase.co';
const SUPA_KEY='sb_publishable_9EhjmwnbK3sSoEwivmvuuQ_yjTGCA6X';
const supaClient=window.supabase.createClient(SUPA_URL,SUPA_KEY);
let gameChannel=null;
let lobbyChannel=null;

const container=$('#game-container');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DECORATIONS - clouds, flowers
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function spawnClouds(){
  for(let i=0;i<4;i++){
    const c=document.createElement('div');
    c.className='cloud';
    const top=5+Math.random()*30;
    const w=80+Math.random()*100;
    c.style.cssText=`top:${top}%;width:${w}px;height:${w*0.4}px;opacity:${0.6+Math.random()*0.4};animation-duration:${25+Math.random()*30}s;animation-delay:-${Math.random()*30}s`;
    container.appendChild(c);
  }
}
function spawnFlowers(){
  const emojis=['ğŸŒ»','ğŸŒ¼','ğŸŒ¸','ğŸŒº','ğŸ’'];
  for(let i=0;i<8;i++){
    const f=document.createElement('div');
    f.className='flower';
    f.textContent=emojis[Math.floor(Math.random()*emojis.length)];
    f.style.cssText=`left:${Math.random()*95}%;top:${52+Math.random()*5}%;animation-delay:${Math.random()*3}s;font-size:${16+Math.random()*12}px`;
    container.appendChild(f);
  }
}
spawnClouds();
spawnFlowers();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO ENGINE (Web Audio API)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initAudio(){
  if(G.audioCtx)return;
  G.audioCtx=new(window.AudioContext||window.webkitAudioContext)();
}
function playTone(freq,dur,type='sine',vol=0.15,detune=0){
  if(!G.soundOn||!G.audioCtx)return;
  const ctx=G.audioCtx;
  const osc=ctx.createOscillator();
  const gain=ctx.createGain();
  osc.type=type;osc.frequency.value=freq;osc.detune.value=detune;
  gain.gain.setValueAtTime(vol,ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+dur);
  osc.connect(gain);gain.connect(ctx.destination);
  osc.start();osc.stop(ctx.currentTime+dur);
}
function playNoise(dur,vol=0.08){
  if(!G.soundOn||!G.audioCtx)return;
  const ctx=G.audioCtx;
  const bufSize=ctx.sampleRate*dur;
  const buf=ctx.createBuffer(1,bufSize,ctx.sampleRate);
  const data=buf.getChannelData(0);
  for(let i=0;i<bufSize;i++)data[i]=(Math.random()*2-1)*0.5;
  const src=ctx.createBufferSource();src.buffer=buf;
  const gain=ctx.createGain();
  gain.gain.setValueAtTime(vol,ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+dur);
  const filter=ctx.createBiquadFilter();
  filter.type='highpass';filter.frequency.value=3000;
  src.connect(filter);filter.connect(gain);gain.connect(ctx.destination);
  src.start();
}

function playChord(freqs,dur,type='sine',vol=0.03){
  freqs.forEach(f=>playTone(f,dur,type,vol));
}

const SFX={
  pick(){playTone(880,0.12,'sine',0.12);playTone(1100,0.1,'sine',0.08);playNoise(0.05,0.04)},
  goldenPick(){playTone(1200,0.15,'sine',0.15);playTone(1500,0.12,'sine',0.1);playTone(1800,0.1,'sine',0.08);setTimeout(()=>playTone(2200,0.2,'sine',0.1),80)},
  combo(){playTone(660,0.08,'square',0.08);playTone(880,0.08,'square',0.08);setTimeout(()=>playTone(1100,0.15,'square',0.1),60)},
  rotten(){playTone(200,0.3,'sawtooth',0.1);playTone(150,0.2,'sawtooth',0.08)},
  powerup(){[660,880,1100,1320].forEach((f,i)=>setTimeout(()=>playTone(f,0.12,'sine',0.1),i*60))},
  birdScare(){playTone(2000,0.05,'sine',0.1);playTone(2500,0.05,'sine',0.08);playTone(1500,0.08,'sine',0.06)},
  levelUp(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>playTone(f,0.2,'sine',0.12),i*100))},
  gameOver(){[440,415,392,349].forEach((f,i)=>setTimeout(()=>playTone(f,0.4,'triangle',0.1),i*200))},
  tick(){playTone(1000,0.05,'sine',0.05)},
  sakePickup(){playTone(500,0.15,'sine',0.1);playTone(750,0.1,'triangle',0.08);setTimeout(()=>playTone(1000,0.08,'sine',0.06),80)},
  sakeThrow(){playTone(300,0.2,'sawtooth',0.08);playTone(200,0.15,'sawtooth',0.06)},
  sakeHit(){playTone(150,0.4,'sawtooth',0.12);playTone(100,0.3,'square',0.08);playNoise(0.3,0.1);setTimeout(()=>{playTone(80,0.3,'sawtooth',0.06)},150)},
  sakeSplash(){[200,180,160,140].forEach((f,i)=>setTimeout(()=>playTone(f,0.15,'sine',0.06),i*50))},
  rainbow(){
    [523,659,784,1047,1319,1568].forEach((f,i)=>setTimeout(()=>playTone(f,0.2,'sine',0.1),i*50));
    setTimeout(()=>playChord([1047,1319,1568],0.4,'sine',0.06),350);
  },
  streakAmazing(){[880,1100,1320,1760].forEach((f,i)=>setTimeout(()=>playTone(f,0.15,'square',0.08),i*60))},
  streakLegendary(){[660,880,1100,1320,1760].forEach((f,i)=>setTimeout(()=>playTone(f,0.18,'square',0.1),i*70))},
  streakGodMode(){[440,660,880,1100,1320,1760,2200].forEach((f,i)=>setTimeout(()=>playTone(f,0.2,'square',0.12),i*50))},
  strawberryRain(){[523,659,784,880,784,659].forEach((f,i)=>setTimeout(()=>playTone(f,0.15,'triangle',0.1),i*80))},
  speedRound(){playTone(440,0.1,'square',0.12);playTone(660,0.1,'square',0.12);setTimeout(()=>{playTone(880,0.15,'square',0.15)},120)},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BETTER BACKGROUND MUSIC - Chord progression
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let bgMusicInterval=null;
let bgMusicBeat=0;
function startBgMusic(){
  if(bgMusicInterval)return;
  // C-G-Am-F chord progression with melody
  const chords=[
    {bass:131,chord:[262,330,392],melody:[523,659,784,659]},  // C
    {bass:196,chord:[247,392,494],melody:[784,659,587,494]},  // G
    {bass:220,chord:[262,330,440],melody:[523,440,523,659]},  // Am
    {bass:175,chord:[262,349,440],melody:[440,523,440,349]},  // F
  ];
  let chordIdx=0;
  let noteInChord=0;
  bgMusicBeat=0;
  bgMusicInterval=setInterval(()=>{
    if(!G.soundOn||!G.running)return;
    const ch=chords[chordIdx];
    const melNote=ch.melody[noteInChord];
    // Melody note
    playTone(melNote,0.22,'triangle',0.04);
    // On beat 0 of chord, play bass + chord
    if(noteInChord===0){
      playTone(ch.bass,0.5,'triangle',0.025);
      ch.chord.forEach(f=>playTone(f,0.4,'sine',0.015));
    }
    // Light arpeggiation on beat 2
    if(noteInChord===2){
      playTone(ch.chord[1],0.3,'sine',0.02);
    }
    noteInChord++;
    if(noteInChord>=4){noteInChord=0;chordIdx=(chordIdx+1)%chords.length}
    bgMusicBeat++;
    // Speed round: add intensity
    if(G.speedRoundActive&&bgMusicBeat%2===0){
      playTone(melNote*2,0.1,'square',0.02);
    }
  },250);
}
function stopBgMusic(){clearInterval(bgMusicInterval);bgMusicInterval=null}

function toggleSound(){
  G.soundOn=!G.soundOn;
  $('#sound-toggle').textContent=G.soundOn?'ğŸ”Š':'ğŸ”‡';
  if(G.soundOn){initAudio();if(G.running)startBgMusic()}
  else stopBgMusic();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HAPTIC FEEDBACK
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function haptic(ms){
  try{if(navigator.vibrate)navigator.vibrate(ms||15)}catch(e){}
}
function hapticPattern(pattern){
  try{if(navigator.vibrate)navigator.vibrate(pattern)}catch(e){}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARTICLE SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function spawnParticles(x,y,count,colors,size=8){
  for(let i=0;i<count;i++){
    const p=document.createElement('div');
    p.className='particle';
    const angle=Math.random()*Math.PI*2;
    const dist=30+Math.random()*60;
    const tx=Math.cos(angle)*dist;
    const ty=Math.sin(angle)*dist-20;
    const c=colors[Math.floor(Math.random()*colors.length)];
    const s=size*(0.5+Math.random());
    p.style.cssText=`left:${x}px;top:${y}px;width:${s}px;height:${s}px;background:${c};--tx:${tx}px;--ty:${ty}px`;
    container.appendChild(p);
    setTimeout(()=>p.remove(),600);
  }
}
function spawnScorePopup(x,y,text,cls=''){
  const el=document.createElement('div');
  el.className='score-popup'+(cls?' '+cls:'');
  el.textContent=text;
  el.style.cssText=`left:${x}px;top:${y}px;transform:translateX(-50%)`;
  container.appendChild(el);
  setTimeout(()=>el.remove(),800);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETTI SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function spawnConfetti(count=60){
  const colors=['#E53935','#FF6F00','#FFD700','#43A047','#1E88E5','#8E24AA','#FF1744','#00E676'];
  for(let i=0;i<count;i++){
    const p=document.createElement('div');
    p.className='confetti-piece';
    const c=colors[Math.floor(Math.random()*colors.length)];
    const left=Math.random()*100;
    const dur=2+Math.random()*2;
    const rot=360+Math.random()*720;
    const w=6+Math.random()*8;
    const h=w*(0.4+Math.random()*0.6);
    const delay=Math.random()*0.5;
    p.style.cssText=`left:${left}%;top:-20px;width:${w}px;height:${h}px;background:${c};border-radius:${Math.random()>0.5?'50%':'2px'};--conf-dur:${dur}s;--conf-rot:${rot}deg;animation-delay:${delay}s`;
    document.body.appendChild(p);
    setTimeout(()=>p.remove(),(dur+delay)*1000+100);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN EFFECTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goldenFlash(){
  const f=document.createElement('div');
  f.className='golden-flash';
  document.body.appendChild(f);
  setTimeout(()=>f.remove(),400);
}
function screenPulse(color){
  const p=document.createElement('div');
  p.className='screen-pulse';
  p.style.borderColor=color;
  document.body.appendChild(p);
  setTimeout(()=>p.remove(),400);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STREAK ANNOUNCEMENTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showStreakAnnounce(text,cls){
  const el=document.createElement('div');
  el.className='streak-announce '+cls;
  el.textContent=text;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1300);
}
function checkStreaks(){
  if(G.combo===10&&!G.streakShown[10]){
    G.streakShown[10]=true;
    showStreakAnnounce('ğŸ”¥ AMAZING!','amazing');
    SFX.streakAmazing();
    screenPulse('#FFD700');
    addScore(50); // streak bonus
    spawnScorePopup(window.innerWidth/2,window.innerHeight*0.4,'+50 STREAK BONUS','combo');
    hapticPattern([50,30,50]);
  }
  if(G.combo===20&&!G.streakShown[20]){
    G.streakShown[20]=true;
    showStreakAnnounce('âš¡ LEGENDARY!','legendary');
    SFX.streakLegendary();
    screenPulse('#E040FB');
    addScore(150);
    spawnScorePopup(window.innerWidth/2,window.innerHeight*0.4,'+150 STREAK BONUS','combo');
    hapticPattern([80,40,80,40,80]);
  }
  if(G.combo===30&&!G.streakShown[30]){
    G.streakShown[30]=true;
    showStreakAnnounce('ğŸŒˆ GOD MODE!','godmode');
    SFX.streakGodMode();
    screenPulse('#FF0000');
    screenPulse('#00FF00');
    addScore(300);
    spawnConfetti(30);
    spawnScorePopup(window.innerWidth/2,window.innerHeight*0.4,'+300 STREAK BONUS','combo');
    hapticPattern([100,50,100,50,100,50,100]);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RAINBOW TRAIL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function spawnRainbowTrail(x,y){
  const colors=['#FF0000','#FF8800','#FFFF00','#00FF00','#0088FF','#8800FF'];
  for(let i=0;i<6;i++){
    const t=document.createElement('div');
    t.className='rainbow-trail';
    t.style.cssText=`left:${x+Math.random()*20-10}px;top:${y+Math.random()*20-10}px;width:${8+Math.random()*6}px;height:${8+Math.random()*6}px;background:${colors[i]}`;
    container.appendChild(t);
    setTimeout(()=>t.remove(),600);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STRAWBERRY SPAWNING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function spawnStrawberry(forceType){
  if(!G.running)return;
  const el=document.createElement('div');
  const rand=Math.random();
  let type=forceType||'normal',emoji='ğŸ“',points=10,cls='';

  if(!forceType){
    if(rand<0.02){type='rainbow';emoji='ğŸ“';cls='rainbow';points=100}
    else if(rand<0.06){type='golden';emoji='ğŸ“';cls='golden';points=50}
    else if(rand<0.12){type='giant';emoji='ğŸ“';cls='giant';points=25}
    else if(rand<0.20){type='rotten';emoji='ğŸ“';cls='rotten';points=-15}
  }

  el.className='strawberry growing'+(cls?' '+cls:'');
  el.dataset.type=type;
  el.dataset.points=points;
  el.innerHTML=`<div class="straw-body">${emoji}</div>`;

  const fw=field.clientWidth,fh=field.clientHeight;
  const x=20+Math.random()*(fw-60);
  const y=30+Math.random()*(fh-80);
  el.style.left=x+'px';
  el.style.top=y+'px';

  el.addEventListener('pointerdown',e=>{e.preventDefault();e.stopPropagation();pickStrawberry(el)},{passive:false});
  field.appendChild(el);
  G.strawberries.push(el);

  // Rainbow trail effect
  if(type==='rainbow'){
    let trailInt=setInterval(()=>{
      if(!el.parentNode||el.classList.contains('picked')){clearInterval(trailInt);return}
      const r=el.getBoundingClientRect();
      spawnRainbowTrail(r.left+r.width/2-container.getBoundingClientRect().left,r.top+r.height/2-container.getBoundingClientRect().top);
    },200);
  }

  // Auto-despawn after some time
  const lifespan=type==='rainbow'?4000:type==='golden'?3500:type==='giant'?5000:6000;
  setTimeout(()=>{
    if(el.parentNode&&!el.classList.contains('picked')){
      el.classList.add('picked');
      setTimeout(()=>el.remove(),400);
      G.strawberries=G.strawberries.filter(s=>s!==el);
    }
  },lifespan);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STRAWBERRY RAIN EVENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function triggerStrawberryRain(){
  if(!G.running)return;
  G.lastRainEvent=Date.now();
  SFX.strawberryRain();
  hapticPattern([30,20,30,20,30]);

  // Show announcement
  const ann=document.createElement('div');
  ann.className='rain-announce';
  ann.textContent='ğŸ“ğŸŒ§ï¸ STRAWBERRY RAIN! ğŸŒ§ï¸ğŸ“';
  document.body.appendChild(ann);
  setTimeout(()=>ann.remove(),2200);

  // Spawn 15-20 strawberries rapidly from the top
  const count=15+Math.floor(Math.random()*6);
  for(let i=0;i<count;i++){
    setTimeout(()=>{
      if(!G.running)return;
      const el=document.createElement('div');
      const rand=Math.random();
      let type='normal',cls='',points=10;
      if(rand<0.1){type='golden';cls='golden';points=50}
      else if(rand<0.2){type='giant';cls='giant';points=25}

      el.className='strawberry rain-drop'+(cls?' '+cls:'');
      el.dataset.type=type;
      el.dataset.points=points;
      el.innerHTML='<div class="straw-body">ğŸ“</div>';

      const fw=field.clientWidth,fh=field.clientHeight;
      const x=10+Math.random()*(fw-40);
      const fallDist=fh*0.8;
      el.style.left=x+'px';
      el.style.top='0px';
      el.style.setProperty('--fall-dist',fallDist+'px');
      el.style.setProperty('--fall-dur',(1.5+Math.random()*1.5)+'s');

      el.addEventListener('pointerdown',e=>{e.preventDefault();e.stopPropagation();pickStrawberry(el)},{passive:false});
      field.appendChild(el);
      G.strawberries.push(el);

      // Remove after falling
      setTimeout(()=>{
        if(el.parentNode&&!el.classList.contains('picked')){
          el.remove();
          G.strawberries=G.strawberries.filter(s=>s!==el);
        }
      },3500);
    },i*100);
  }
}

function pickStrawberry(el){
  if(!G.running||el.classList.contains('picked'))return;
  el.classList.add('picked');
  const type=el.dataset.type;
  let pts=parseInt(el.dataset.points);
  const rect=el.getBoundingClientRect();
  const cx=rect.left+rect.width/2;
  const cy=rect.top+rect.height/2;

  // Haptic feedback
  haptic(type==='rainbow'?40:type==='golden'?25:15);

  if(type==='rotten'){
    G.rottenHit++;
    G.combo=0;
    G.streakShown={};
    updateCombo();
    pts=G.activePowers.shield?0:-15;
    if(pts<0){
      addScore(pts);
      spawnParticles(cx,cy,8,['#5D4037','#795548','#4E342E'],6);
      spawnScorePopup(cx,cy,pts,'negative');
      SFX.rotten();
      screenShake();
    }else{
      spawnScorePopup(cx,cy,'BLOCKED!','combo');
    }
  }else{
    G.picked++;
    G.combo++;
    if(G.combo>G.maxCombo)G.maxCombo=G.combo;
    if(type==='golden')G.goldenPicked++;
    if(type==='rainbow')G.rainbowPicked++;

    let mult=1;
    if(G.activePowers.doublePoints)mult*=2;
    if(G.combo>=30)mult*=4;
    else if(G.combo>=20)mult*=3;
    else if(G.combo>=10)mult*=3;
    else if(G.combo>=5)mult*=2;
    pts=pts*mult;

    addScore(pts);
    updateCombo();
    checkStreaks();
    $('#picked-count').textContent=G.picked;

    const colors=type==='rainbow'?['#FF0000','#FF8800','#FFFF00','#00FF00','#0088FF','#8800FF']:type==='golden'?['#FFD700','#FFF176','#FFB300','#FF8F00']:type==='giant'?['#E53935','#FF5252','#FF8A80','#43A047']:['#E53935','#FF5252','#FF8A80','#EF9A9A'];
    spawnParticles(cx,cy,type==='rainbow'?20:type==='golden'?16:type==='giant'?12:8,colors);

    let label='+'+pts;
    if(mult>1)label+=` (x${mult})`;
    spawnScorePopup(cx,cy,label,G.combo>=5?'combo':'');

    if(type==='rainbow'){
      SFX.rainbow();
      goldenFlash();
      screenPulse('#FF0000');
      spawnConfetti(15);
      hapticPattern([30,20,30,20,30,20,30]);
    }else if(type==='golden'){
      SFX.goldenPick();
      goldenFlash();
    }else{
      SFX.pick();
    }
    if(G.combo>0&&G.combo%5===0){SFX.combo();screenShake();screenPulse('#FFD700')}
  }

  setTimeout(()=>el.remove(),400);
  G.strawberries=G.strawberries.filter(s=>s!==el);

  // multiplayer broadcast
  if(G.isMultiplayer){
    broadcastMP({type:'pick',x:cx/window.innerWidth,y:cy/window.innerHeight,stype:type});
    broadcastScore();
  }
}

function addScore(pts){
  G.score=Math.max(0,G.score+pts);
  const sv=$('#score-value');
  sv.textContent=G.score;
  sv.classList.add('bump');
  setTimeout(()=>sv.classList.remove('bump'),150);
}
function updateCombo(){
  const cd=$('#combo-display');
  if(G.combo>=3){
    cd.classList.add('active');
    $('#combo-value').textContent=G.combo;
  }else{
    cd.classList.remove('active');
  }
}
function screenShake(){
  container.classList.remove('shake');
  void container.offsetWidth;
  container.classList.add('shake');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BIRDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function spawnBird(){
  if(!G.running)return;
  const el=document.createElement('div');
  el.className='bird';
  el.textContent='ğŸ¦';
  const fw=field.clientWidth,fh=field.clientHeight;
  el.style.left=(20+Math.random()*(fw-60))+'px';
  el.style.top=(20+Math.random()*(fh-80))+'px';
  el.addEventListener('pointerdown',e=>{
    e.preventDefault();e.stopPropagation();
    scareBird(el);
  },{passive:false});
  field.appendChild(el);
  G.birds.push(el);

  // Bird steals a strawberry after 2s
  el._stealTimer=setTimeout(()=>{
    if(!el.parentNode||el.classList.contains('scared'))return;
    const target=G.strawberries.find(s=>!s.classList.contains('picked')&&s.dataset.type!=='rotten');
    if(target){
      target.classList.add('picked');
      setTimeout(()=>target.remove(),400);
      G.strawberries=G.strawberries.filter(s=>s!==target);
      spawnScorePopup(
        el.getBoundingClientRect().left,
        el.getBoundingClientRect().top,
        'ğŸ¦ Stolen!','negative'
      );
    }
    el.classList.add('scared');
    setTimeout(()=>el.remove(),500);
    G.birds=G.birds.filter(b=>b!==el);
  },2500);
}
function scareBird(el){
  if(el.classList.contains('scared'))return;
  clearTimeout(el._stealTimer);
  el.classList.add('scared');
  SFX.birdScare();
  addScore(5);
  haptic(10);
  const rect=el.getBoundingClientRect();
  spawnScorePopup(rect.left,rect.top,'+5 ğŸ¦','');
  spawnParticles(rect.left+14,rect.top+14,6,['#8D6E63','#BCAAA4','#D7CCC8'],5);
  setTimeout(()=>el.remove(),500);
  G.birds=G.birds.filter(b=>b!==el);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POWER-UPS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const POWER_TYPES=[
  {id:'doublePoints',emoji:'â­',label:'2x Points',dur:8000},
  {id:'magnet',emoji:'ğŸ§²',label:'Magnet',dur:6000},
  {id:'freeze',emoji:'â„ï¸',label:'Freeze Time',dur:5000},
  {id:'shield',emoji:'ğŸ›¡ï¸',label:'Shield',dur:7000},
];
function spawnPowerup(){
  if(!G.running)return;
  const pt=POWER_TYPES[Math.floor(Math.random()*POWER_TYPES.length)];
  const el=document.createElement('div');
  el.className='powerup';
  el.textContent=pt.emoji;
  el.dataset.powerId=pt.id;
  el.dataset.powerDur=pt.dur;
  el.dataset.powerLabel=pt.label;

  const fw=field.clientWidth,fh=field.clientHeight;
  el.style.left=(20+Math.random()*(fw-60))+'px';
  el.style.top=(20+Math.random()*(fh-80))+'px';

  el.addEventListener('pointerdown',e=>{
    e.preventDefault();e.stopPropagation();
    collectPowerup(el);
  },{passive:false});
  field.appendChild(el);
  G.powerups.push(el);

  setTimeout(()=>{
    if(el.parentNode&&!el.classList.contains('collected')){
      el.classList.add('collected');
      setTimeout(()=>el.remove(),400);
      G.powerups=G.powerups.filter(p=>p!==el);
    }
  },5000);
}
function collectPowerup(el){
  if(el.classList.contains('collected'))return;
  el.classList.add('collected');
  const id=el.dataset.powerId;
  const dur=parseInt(el.dataset.powerDur);
  const label=el.dataset.powerLabel;
  SFX.powerup();
  haptic(20);

  const rect=el.getBoundingClientRect();
  spawnScorePopup(rect.left,rect.top,label+'!','combo');
  spawnParticles(rect.left+16,rect.top+16,12,['#FFD700','#FFF176','#FFC107','#FF9800']);

  activatePower(id,dur,el.textContent);
  setTimeout(()=>el.remove(),400);
  G.powerups=G.powerups.filter(p=>p!==el);
}
function activatePower(id,dur,emoji){
  if(G.activePowers[id])clearTimeout(G.activePowers[id].timer);

  G.activePowers[id]={end:Date.now()+dur};

  // Special: freeze stops timer
  if(id==='freeze')G._frozen=true;

  // Special: magnet auto-collects nearby
  if(id==='magnet')startMagnet();

  // Show indicator
  renderPowerupBar();

  G.activePowers[id].timer=setTimeout(()=>{
    delete G.activePowers[id];
    if(id==='freeze')G._frozen=false;
    if(id==='magnet')stopMagnet();
    renderPowerupBar();
  },dur);
}
function renderPowerupBar(){
  const bar=$('#powerup-bar');
  bar.innerHTML='';
  for(const[id,pw]of Object.entries(G.activePowers)){
    const pt=POWER_TYPES.find(p=>p.id===id);
    if(!pt)continue;
    const remaining=Math.max(0,pw.end-Date.now());
    const pct=(remaining/pt.dur)*100;
    const ind=document.createElement('div');
    ind.className='powerup-indicator';
    ind.innerHTML=`${pt.emoji} ${pt.label} <div class="pw-timer"><div class="pw-timer-fill" style="width:${pct}%"></div></div>`;
    bar.appendChild(ind);
  }
}
let magnetInterval=null;
function startMagnet(){
  if(magnetInterval)clearInterval(magnetInterval);
  magnetInterval=setInterval(()=>{
    if(!G.running||!G.activePowers.magnet)return;
    G.strawberries.forEach(s=>{
      if(s.classList.contains('picked')||s.dataset.type==='rotten')return;
      // Auto pick!
      pickStrawberry(s);
    });
  },600);
}
function stopMagnet(){clearInterval(magnetInterval);magnetInterval=null}

// Update powerup bar timers
let powerupBarInterval=null;


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAKE ATTACK SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function spawnSake(){
  if(!G.running||!G.isMultiplayer)return;
  const el=document.createElement('div');
  el.className='sake-item';
  el.textContent='ğŸ¶';
  const fw=field.clientWidth,fh=field.clientHeight;
  el.style.left=(20+Math.random()*(fw-60))+'px';
  el.style.top=(20+Math.random()*(fh-80))+'px';
  el.addEventListener('pointerdown',e=>{
    e.preventDefault();e.stopPropagation();
    collectSake(el);
  },{passive:false});
  field.appendChild(el);
  G.sakeItems.push(el);
  // Despawn after 8s
  setTimeout(()=>{
    if(el.parentNode&&!el.classList.contains('collected')){
      el.classList.add('collected');
      setTimeout(()=>el.remove(),400);
      G.sakeItems=G.sakeItems.filter(s=>s!==el);
    }
  },8000);
}

function collectSake(el){
  if(el.classList.contains('collected'))return;
  el.classList.add('collected');
  G.sakeAmmo=Math.min(G.sakeAmmo+1,5);
  updateSakeAmmo();
  SFX.sakePickup();
  const rect=el.getBoundingClientRect();
  spawnScorePopup(rect.left,rect.top,'ğŸ¶ +1 Sake!','combo');
  spawnParticles(rect.left+14,rect.top+14,8,['#8B4513','#D2691E','#F4A460','#FFDEAD']);
  setTimeout(()=>el.remove(),400);
  G.sakeItems=G.sakeItems.filter(s=>s!==el);
  // Make other player cursors targetable
  if(G.sakeAmmo>0)enableSakeTargeting();
}

function updateSakeAmmo(){
  const ammoEl=$('#sake-ammo');
  const countEl=$('#sake-count');
  if(!ammoEl||!countEl)return;
  countEl.textContent=G.sakeAmmo;
  if(G.sakeAmmo>0){ammoEl.classList.add('has-ammo')}
  else{ammoEl.classList.remove('has-ammo');disableSakeTargeting()}
}

function enableSakeTargeting(){
  Object.entries(remoteCursors).forEach(([id,el])=>{
    el.classList.add('targetable');
    if(!el._sakeTarget){
      const t=document.createElement('div');
      t.className='sake-target';
      el.appendChild(t);
      el._sakeTarget=t;
    }
    // Remove old handler first
    if(el._sakeHandler)el.removeEventListener('pointerdown',el._sakeHandler);
    el._sakeHandler=function(e){
      e.preventDefault();e.stopPropagation();
      throwSakeAt(id,el);
    };
    el.addEventListener('pointerdown',el._sakeHandler,{passive:false});
  });
}

function disableSakeTargeting(){
  Object.entries(remoteCursors).forEach(([id,el])=>{
    el.classList.remove('targetable');
    if(el._sakeTarget){el._sakeTarget.remove();el._sakeTarget=null}
    if(el._sakeHandler){el.removeEventListener('pointerdown',el._sakeHandler);el._sakeHandler=null}
  });
}

function throwSakeAt(targetId,targetEl){
  if(G.sakeAmmo<=0)return;
  G.sakeAmmo--;
  updateSakeAmmo();
  SFX.sakeThrow();
  
  // Animate projectile from bottom-right to target
  const proj=document.createElement('div');
  proj.className='sake-projectile';
  proj.textContent='ğŸ¶';
  proj.style.left=(window.innerWidth-60)+'px';
  proj.style.top=(window.innerHeight-100)+'px';
  document.body.appendChild(proj);
  
  const targetRect=targetEl.getBoundingClientRect();
  requestAnimationFrame(()=>{
    proj.style.left=targetRect.left+'px';
    proj.style.top=targetRect.top+'px';
    proj.style.transform='rotate(720deg) scale(0.5)';
  });
  
  setTimeout(()=>{
    proj.remove();
    // Splash effect
    const splash=document.createElement('div');
    splash.className='sake-splash';
    splash.textContent='ğŸ’¥ğŸ¶';
    splash.style.left=targetRect.left+'px';
    splash.style.top=targetRect.top+'px';
    document.body.appendChild(splash);
    setTimeout(()=>splash.remove(),800);
    SFX.sakeSplash();
  },400);
  
  // Broadcast the attack
  broadcastMP({type:'sake_attack',from:G.myId,fromName:G.players[G.myId]?.name||'?',target:targetId});
  spawnScorePopup(targetRect.left,targetRect.top,'ğŸ¶ SAKE ATTACK!','combo');
}

function receiveSakeHit(fromName){
  if(G.isDrunk)return; // Already drunk, ignore
  G.isDrunk=true;
  SFX.sakeHit();
  screenShake();
  
  // Flash
  const flash=document.createElement('div');
  flash.className='sake-hit-flash';
  document.body.appendChild(flash);
  setTimeout(()=>flash.remove(),500);
  
  // Drunk overlay
  const overlay=document.createElement('div');
  overlay.className='drunk-overlay';
  overlay.id='drunk-overlay';
  document.body.appendChild(overlay);
  
  // Wobble the game
  container.classList.add('drunk');
  
  // Score penalty
  addScore(-20);
  spawnScorePopup(window.innerWidth/2,window.innerHeight/2,'-20 ğŸ¶ DRUNK!','negative');
  spawnScorePopup(window.innerWidth/2,window.innerHeight/2+40,fromName+' got you!','');
  
  // Combo reset
  G.combo=0;
  G.streakShown={};
  updateCombo();
  
  // Reverse controls for 4 seconds - clicks register offset
  G._drunkOffset={x:(Math.random()-0.5)*80,y:(Math.random()-0.5)*80};
  
  if(G.drunkTimer)clearTimeout(G.drunkTimer);
  G.drunkTimer=setTimeout(()=>{
    G.isDrunk=false;
    G._drunkOffset=null;
    container.classList.remove('drunk');
    const ov=document.getElementById('drunk-overlay');
    if(ov)ov.remove();
  },4000);
  
  if(G.isMultiplayer)broadcastScore();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESSIVE DIFFICULTY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getSpawnRate(){
  // Start at 800ms, go to 300ms linearly over 60 seconds
  const elapsed=G.roundDuration-G.timeLeft;
  const progress=Math.min(elapsed/G.roundDuration,1);
  let rate=800-(500*progress); // 800 -> 300
  if(G.speedRoundActive)rate=Math.max(rate/3,100);
  return Math.max(rate,100);
}
function getBirdRate(){
  const elapsed=G.roundDuration-G.timeLeft;
  const progress=Math.min(elapsed/G.roundDuration,1);
  let rate=8000-(5000*progress); // 8000 -> 3000
  if(G.speedRoundActive)rate=Math.max(rate/3,800);
  return Math.max(rate,800);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPEED ROUND (last 10 seconds)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function activateSpeedRound(){
  if(G.speedRoundActive)return;
  G.speedRoundActive=true;
  container.classList.add('speed-round');
  SFX.speedRound();
  hapticPattern([100,50,100,50,100]);

  const ann=document.createElement('div');
  ann.className='streak-announce amazing';
  ann.textContent='âš¡ SPEED ROUND! âš¡';
  document.body.appendChild(ann);
  setTimeout(()=>ann.remove(),1300);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RANK CALCULATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getRank(score){
  if(score>=2000)return{emoji:'ğŸ†',label:'LEGEND',color:'#FFD700'};
  if(score>=1200)return{emoji:'ğŸ’',label:'DIAMOND',color:'#00BCD4'};
  if(score>=700)return{emoji:'ğŸ¥‡',label:'GOLD',color:'#FFC107'};
  if(score>=400)return{emoji:'ğŸ¥ˆ',label:'SILVER',color:'#9E9E9E'};
  return{emoji:'ğŸ¥‰',label:'BRONZE',color:'#8D6E63'};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATED SCORE COUNTER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function animateScoreCounter(targetScore,el,duration=1500){
  const start=0;
  const startTime=performance.now();
  function tick(now){
    const elapsed=now-startTime;
    const progress=Math.min(elapsed/duration,1);
    // Ease out cubic
    const eased=1-Math.pow(1-progress,3);
    const current=Math.round(start+(targetScore-start)*eased);
    el.textContent=current;
    if(progress<1)requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME TIMER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startTimer(){
  G.timers.gameTimer=setInterval(()=>{
    if(!G.running)return;
    if(G._frozen)return; // freeze power-up
    G.timeLeft--;
    const tv=$('#timer-value');
    tv.textContent=G.timeLeft;
    if(G.timeLeft<=10){
      tv.classList.add('urgent');
      if(G.timeLeft>0)SFX.tick();
      // Activate speed round
      activateSpeedRound();
    }
    else tv.classList.remove('urgent');

    // Strawberry Rain every 15 seconds
    const elapsed=G.roundDuration-G.timeLeft;
    if(elapsed>0&&elapsed%15===0&&G.timeLeft>5){
      triggerStrawberryRain();
    }

    if(G.timeLeft<=0){endGame()}
  },1000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DYNAMIC SPAWNER (progressive difficulty)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startDynamicSpawner(){
  // Instead of fixed setInterval, use dynamic timeout
  function scheduleStrawberry(){
    if(!G.running)return;
    G.timers._strawTimeout=setTimeout(()=>{
      spawnStrawberry();
      scheduleStrawberry();
    },getSpawnRate());
  }
  function scheduleBird(){
    if(!G.running)return;
    G.timers._birdTimeout=setTimeout(()=>{
      spawnBird();
      scheduleBird();
    },getBirdRate());
  }
  scheduleStrawberry();
  scheduleBird();
  G.timers.powerSpawn=setInterval(spawnPowerup,G.powerupRate);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME LOOP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startGame(){
  // â˜… BUG FIX: Clear ALL existing timers first
  Object.values(G.timers).forEach(t=>{clearInterval(t);clearTimeout(t)});
  G.timers={};
  if(bgMusicInterval){clearInterval(bgMusicInterval);bgMusicInterval=null}
  if(magnetInterval){clearInterval(magnetInterval);magnetInterval=null}
  if(powerupBarInterval){clearInterval(powerupBarInterval);powerupBarInterval=null}
  if(G.drunkTimer){clearTimeout(G.drunkTimer);G.drunkTimer=null}

  initAudio();
  G.score=0;G.picked=0;G.combo=0;G.maxCombo=0;
  G.goldenPicked=0;G.rottenHit=0;G.rainbowPicked=0;
  G.timeLeft=G.roundDuration;G.running=true;G._frozen=false;
  G.activePowers={};G.strawberries=[];G.birds=[];G.powerups=[];
  G.speedRoundActive=false;G.lastRainEvent=0;G.streakShown={};
  G.gameOverShown=false;

  container.classList.remove('speed-round','drunk');
  const drunkOv=document.getElementById('drunk-overlay');
  if(drunkOv)drunkOv.remove();

  $('#score-value').textContent='0';
  $('#timer-value').textContent=G.timeLeft;
  $('#timer-value').classList.remove('urgent');
  $('#picked-count').textContent='0';
  $('#combo-display').classList.remove('active');
  $('#powerup-bar').innerHTML='';

  // Clear field
  field.querySelectorAll('.strawberry,.bird,.powerup,.player-cursor,.sake-item').forEach(function(e){e.remove()});

  // Start dynamic spawners (progressive difficulty)
  startDynamicSpawner();

  G.sakeAmmo=0;G.isDrunk=false;G.sakeItems=[];updateSakeAmmo();
  if(G.isMultiplayer){G.timers.sakeSpawn=setInterval(spawnSake,6000);setTimeout(spawnSake,3000)}

  // Spawn initial batch
  for(let i=0;i<6;i++)setTimeout(spawnStrawberry,i*120);

  startTimer();
  startBgMusic();

  // Powerup bar updater
  powerupBarInterval=setInterval(()=>{if(G.running)renderPowerupBar()},200);

  // Show scoreboard if multiplayer
  if(G.isMultiplayer)$('#scoreboard').classList.add('visible');
}

function endGame(){
  G.running=false;
  G.gameOverShown=true;
  stopBgMusic();

  // â˜… BUG FIX: Clear ALL timers properly
  Object.values(G.timers).forEach(t=>{clearInterval(t);clearTimeout(t)});
  G.timers={};
  if(magnetInterval){clearInterval(magnetInterval);magnetInterval=null}
  if(powerupBarInterval){clearInterval(powerupBarInterval);powerupBarInterval=null}

  for(const k of Object.keys(G.activePowers)){
    clearTimeout(G.activePowers[k].timer);
  }
  G.activePowers={};
  G.speedRoundActive=false;
  container.classList.remove('speed-round','drunk');
  stopMagnet();

  SFX.gameOver();

  // Rank
  const rank=getRank(G.score);
  $('#rank-badge').textContent=rank.emoji;
  $('#rank-label').textContent=rank.label;
  $('#rank-label').style.color=rank.color;

  // Animated score counter
  const finalScoreEl=$('#final-score');
  finalScoreEl.textContent='0';
  setTimeout(()=>animateScoreCounter(G.score,finalScoreEl,1500),300);

  $('#stat-picked').textContent=G.picked;
  $('#stat-combo').textContent=G.maxCombo;
  $('#stat-golden').textContent=G.goldenPicked;
  $('#stat-rotten').textContent=G.rottenHit;

  // Confetti explosion on game over!
  setTimeout(()=>spawnConfetti(80),200);

  // Leaderboard
  const lb=$('#final-leaderboard');
  if(G.isMultiplayer){
    G.players[G.myId]={...G.players[G.myId],score:G.score};
    broadcastScore();
    const sorted=Object.values(G.players).sort((a,b)=>b.score-a.score);
    let html='<h3>ğŸ† Final Standings</h3>';
    sorted.forEach((p,i)=>{
      const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'';
      html+=`<div class="final-lb-entry"><span>${medal} ${p.name}</span><span>${p.score}</span></div>`;
    });
    lb.innerHTML=html;
  }else{
    lb.innerHTML='';
  }

  showScreen('gameover-screen');

  // Enable quick restart after a short delay
  setTimeout(()=>{G._canQuickRestart=true},800);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN NAVIGATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showScreen(id){
  $$('.screen').forEach(s=>s.classList.add('hidden'));
  if(id){$('#'+id).classList.remove('hidden')}
}
function requireName(){
  const name=$('#player-name').value.trim();
  if(!name){
    const inp=$('#player-name');
    inp.style.border='2px solid #FF1744';
    inp.placeholder='Enter your name!';
    inp.focus();
    inp.addEventListener('input',function(){inp.style.border=''},{ once:true });
    return false;
  }
  return true;
}
function startSinglePlayer(){
  if(!requireName())return;
  stopLobbyScanning();
  initAudio();
  G.isMultiplayer=false;
  G.isHost=false;
  const name=$('#player-name').value.trim()||'Harrison';
  G.myId='solo';
  G.players={solo:{name,score:0}};
  showScreen(null);
  $('#scoreboard').classList.remove('visible');
  startGame();
}
function playAgain(){
  G._canQuickRestart=false;
  G.gameOverShown=false;
  showScreen(null);
  if(G.isMultiplayer&&G.isHost)broadcastMP({type:'restart'});
  startGame();
}
function backToTitle(){
  G.running=false;
  G.gameOverShown=false;
  G._canQuickRestart=false;
  stopBgMusic();
  // Clear all timers
  Object.values(G.timers).forEach(t=>{clearInterval(t);clearTimeout(t)});
  G.timers={};
  if(magnetInterval){clearInterval(magnetInterval);magnetInterval=null}
  if(powerupBarInterval){clearInterval(powerupBarInterval);powerupBarInterval=null}
  if(G.isHost)unregisterLobbyGame(G.roomCode);
  if(gameChannel){supaClient.removeChannel(gameChannel);gameChannel=null}
  G.isMultiplayer=false;
  G.speedRoundActive=false;
  container.classList.remove('speed-round','drunk');
  showScreen('title-screen');
  startLobbyScanning();
  $('#scoreboard').classList.remove('visible');
  field.querySelectorAll('.strawberry,.bird,.powerup,.player-cursor,.sake-item').forEach(function(e){e.remove()});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUICK RESTART (tap anywhere or space)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown',e=>{
  if(e.code==='Space'&&G.gameOverShown&&G._canQuickRestart){
    e.preventDefault();
    playAgain();
  }
});
document.addEventListener('pointerdown',e=>{
  if(G.gameOverShown&&G._canQuickRestart){
    // Don't trigger if clicking a button
    if(e.target.closest('.btn'))return;
    playAgain();
  }
},{passive:true});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MULTIPLAYER - Supabase Realtime
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function genRoomCode(){
  var chars='ABCDEFGHJKLMNPQRSTUVWXYZ';
  var c='';for(var i=0;i<4;i++)c+=chars[Math.floor(Math.random()*chars.length)];
  return c;
}

function broadcastMP(data){
  if(gameChannel){
    gameChannel.send({type:'broadcast',event:'game',payload:data});
  }
}
function broadcastScore(){
  broadcastMP({type:'score',id:G.myId,score:G.score});
}

function showHostScreen(){
  if(!requireName())return;
  stopLobbyScanning();
  initAudio();
  var name=$('#player-name').value.trim()||'Host';
  G.isHost=true;G.isMultiplayer=true;
  G.roomCode=genRoomCode();
  G.myId='host-'+G.roomCode;
  G.players={};
  G.players[G.myId]={name:name,score:0};

  showScreen('multiplayer-screen');
  $('#room-code').textContent=G.roomCode;
  $('#lobby-status').textContent='Creating room...';
  $('#join-input').style.display='none';
  $('#start-mp-btn').style.display='none';

  // Create Supabase channel for this game
  gameChannel=supaClient.channel('game-'+G.roomCode,{config:{broadcast:{self:false}}});
  gameChannel.on('broadcast',{event:'game'},function(msg){
    handleMPData(msg.payload);
  });
  gameChannel.subscribe(function(status){
    if(status==='SUBSCRIBED'){
      $('#lobby-status').textContent='Room ready! Share the code!';
      $('#start-mp-btn').style.display='block';
      updatePlayersList();
      registerLobbyGame(G.roomCode,name,1);
    }else if(status==='CHANNEL_ERROR'){
      $('#lobby-status').textContent='Error creating room. Try again.';
    }
  });
}

function showJoinScreen(){
  if(!requireName())return;
  stopLobbyScanning();
  initAudio();
  G.isHost=false;G.isMultiplayer=true;
  showScreen('multiplayer-screen');
  $('#room-code').textContent='????';
  $('#lobby-status').textContent='Enter the room code to join';
  $('#join-input').style.display='flex';
  $('#start-mp-btn').style.display='none';
}

function joinRoom(){
  var code=$('#join-code').value.trim().toUpperCase();
  if(code.length!==4)return;
  doJoinGame(code);
}

function doJoinGame(code){
  var name=$('#player-name').value.trim()||'Player';
  G.roomCode=code;
  G.myId='player-'+Math.random().toString(36).substr(2,5);
  G.players={};
  G.players[G.myId]={name:name,score:0};

  $('#lobby-status').textContent='Joining...';
  $('#join-input').style.display='none';
  $('#room-code').textContent=code;

  // Join Supabase channel
  gameChannel=supaClient.channel('game-'+code,{config:{broadcast:{self:false}}});
  gameChannel.on('broadcast',{event:'game'},function(msg){
    handleMPData(msg.payload);
  });
  gameChannel.subscribe(function(status){
    if(status==='SUBSCRIBED'){
      // Tell host we joined
      broadcastMP({type:'join',id:G.myId,name:name});
      $('#lobby-status').textContent='Connected! Waiting for host to start...';
    }else if(status==='CHANNEL_ERROR'){
      $('#lobby-status').textContent='Could not join. Try again.';
      setTimeout(function(){showScreen('title-screen');startLobbyScanning()},2000);
    }
  });
}

function quickJoinGame(code){
  if(!requireName())return;
  stopLobbyScanning();
  initAudio();
  G.isHost=false;G.isMultiplayer=true;
  showScreen('multiplayer-screen');
  $('#start-mp-btn').style.display='none';
  doJoinGame(code);
}

function handleMPData(data){
  switch(data.type){
    case 'join':
      G.players[data.id]={name:data.name,score:0};
      updatePlayersList();
      broadcastMP({type:'players',players:G.players});
      if(G.isHost)registerLobbyGame(G.roomCode,G.players[G.myId]?.name||'Unknown',Object.keys(G.players).length);
      SFX.powerup();
      break;
    case 'players':
      var myData=G.players[G.myId];
      G.players=data.players;
      if(myData)G.players[G.myId]=myData;
      else G.players[G.myId]={name:$('#player-name').value.trim()||'Player',score:0};
      updatePlayersList();
      updateScoreboard();
      break;
    case 'start':
      showScreen(null);
      startGame();
      break;
    case 'restart':
      showScreen(null);
      startGame();
      break;
    case 'score':
      if(G.players[data.id])G.players[data.id].score=data.score;
      updateScoreboard();
      break;
    case 'pick':
      showRemotePick(data.x,data.y,data.stype);
      break;
    case 'cursor':
      showRemoteCursor(data.id,data.name,data.x,data.y);
      break;
    case 'sake_attack':
      if(data.target===G.myId)receiveSakeHit(data.fromName);
      break;
    case 'gameover':
      if(data.players)G.players=data.players;
      break;
  }
}

function startMultiplayerGame(){
  if(!G.isHost)return;
  unregisterLobbyGame(G.roomCode);
  broadcastMP({type:'players',players:G.players});
  broadcastMP({type:'start'});
  showScreen(null);
  startGame();
}

function updatePlayersList(){
  var list=$('#players-list');
  list.innerHTML='';
  for(var id in G.players){
    var p=G.players[id];
    var tag=document.createElement('div');
    tag.className='player-tag';
    tag.textContent=(id===G.myId?'â­ ':'')+p.name;
    list.appendChild(tag);
  }
}
function updateScoreboard(){
  var entries=$('#scoreboard-entries');
  var sorted=Object.entries(G.players).sort(function(a,b){return b[1].score-a[1].score});
  entries.innerHTML='';
  sorted.forEach(function(item){
    var id=item[0],p=item[1];
    var d=document.createElement('div');
    d.className='sb-entry'+(id===G.myId?' me':'');
    d.innerHTML='<span class="sb-name">'+p.name+'</span><span class="sb-score">'+p.score+'</span>';
    entries.appendChild(d);
  });
}

function showRemotePick(nx,ny,stype){
  var x=nx*window.innerWidth;
  var y=ny*window.innerHeight;
  var colors=stype==='golden'?['#FFD700','#FFF176']:stype==='rainbow'?['#FF0000','#00FF00','#0088FF']:['#E53935','#FF5252','#FF8A80'];
  spawnParticles(x,y,5,colors,5);
}

var remoteCursors={};
function showRemoteCursor(id,name,nx,ny){
  var el=remoteCursors[id];
  if(!el){
    el=document.createElement('div');
    el.className='player-cursor';
    el.innerHTML='<span class="cursor-name">'+(name||'?')+'</span>ğŸ‘†';
    field.appendChild(el);
    remoteCursors[id]=el;
  }
  el.style.left=(nx*field.clientWidth)+'px';
  el.style.top=(ny*field.clientHeight)+'px';
  if(G.sakeAmmo>0&&!el.classList.contains('targetable'))enableSakeTargeting();
}

// Send cursor position periodically
var lastCursorSend=0;
document.addEventListener('pointermove',function(e){
  if(!G.isMultiplayer||!G.running)return;
  var now=Date.now();
  if(now-lastCursorSend<100)return; // throttle to 10fps
  lastCursorSend=now;
  var name=G.players[G.myId]?G.players[G.myId].name:'?';
  broadcastMP({type:'cursor',id:G.myId,name:name,x:e.clientX/window.innerWidth,y:e.clientY/window.innerHeight});
});




/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIVE GAMES LOBBY (API-BACKED)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LOBBY_API=window.location.origin+'/api/lobby';
let lobbyScanning=false;
let discoveredGames=[];
let lobbyScanInterval=null;
let lobbyHeartbeatInterval=null;

function startLobbyScanning(){
  if(lobbyScanning)return;
  lobbyScanning=true;
  discoveredGames=[];
  fetchLobbyGames();
  lobbyScanInterval=setInterval(fetchLobbyGames,3000);
}

function stopLobbyScanning(){
  lobbyScanning=false;
  if(lobbyScanInterval){clearInterval(lobbyScanInterval);lobbyScanInterval=null}
  discoveredGames=[];
}

function fetchLobbyGames(){
  fetch(LOBBY_API).then(r=>r.json()).then(games=>{
    discoveredGames=games;
    renderLiveGames();
  }).catch(()=>{});
}

function registerLobbyGame(roomCode,hostName,playerCount){
  fetch(LOBBY_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomCode,hostName,playerCount})}).catch(()=>{});
  // Heartbeat every 15s
  if(lobbyHeartbeatInterval)clearInterval(lobbyHeartbeatInterval);
  lobbyHeartbeatInterval=setInterval(()=>{
    const pc=Object.keys(G.players).length;
    fetch(LOBBY_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomCode,hostName,playerCount:pc})}).catch(()=>{});
  },15000);
}

function unregisterLobbyGame(roomCode){
  if(lobbyHeartbeatInterval){clearInterval(lobbyHeartbeatInterval);lobbyHeartbeatInterval=null}
  fetch(LOBBY_API,{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomCode})}).catch(()=>{});
}

function renderLiveGames(){
  const list=$('#live-games-list');
  const games=discoveredGames;
  
  if(!games||games.length===0){
    list.innerHTML='<div class="no-games">No live games right now. Host one!</div>';
    return;
  }
  
  list.innerHTML='';
  games.forEach(g=>{
    const card=document.createElement('div');
    card.className='live-game-card';
    const hn=g.hostName||'Unknown';
    const pc=g.playerCount||1;
    const rc=g.roomCode||'???';
    card.innerHTML='<div><div class="game-host">ğŸ“ '+hn+'\'s Farm</div><div class="game-players">ğŸ‘¥ '+pc+' player'+(pc!==1?'s':'')+' Â· Room: '+rc+'</div></div><div class="join-arrow">â†’</div>';
    card.addEventListener('click',function(){quickJoinGame(rc)});
    list.appendChild(card);
  });
}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOUCH / POINTER HANDLING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Prevent default touch behaviors
document.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});

// Tap on field = combo breaker (miss)
field.addEventListener('pointerdown',e=>{
  if(!G.running)return;
  if(e.target===field||e.target.classList.contains('dirt-rows')||e.target.classList.contains('grass-blades')){
    if(G.combo>=3){
      G.combo=0;
      G.streakShown={};
      updateCombo();
    }
  }
},{passive:true});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD SHORTCUTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown',e=>{
  if(e.key==='m'||e.key==='M')toggleSound();
  if(e.key==='Escape')backToTitle();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
showScreen('title-screen');
startLobbyScanning();

// Focus name input
$('#player-name').addEventListener('focus',()=>initAudio());
$('#join-code').addEventListener('keydown',e=>{if(e.key==='Enter')joinRoom()});
</script>
</body>
</html>
